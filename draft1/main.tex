%File: anonymous-submission-latex-2024.tex
\documentclass[letterpaper]{article} % DO NOT CHANGE THIS
\usepackage[submission]{aaai24}  % DO NOT CHANGE THIS
\usepackage{times}  % DO NOT CHANGE THIS
\usepackage{helvet}  % DO NOT CHANGE THIS
\usepackage{courier}  % DO NOT CHANGE THIS
\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\graphicspath{ {./images/} }
\urlstyle{rm} % DO NOT CHANGE THIS
\def\UrlFont{\rm}  % DO NOT CHANGE THIS
\usepackage{natbib}  % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\usepackage{caption} % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\frenchspacing  % DO NOT CHANGE THIS
\setlength{\pdfpagewidth}{8.5in} % DO NOT CHANGE THIS
\setlength{\pdfpageheight}{11in} % DO NOT CHANGE THIS
%
% These are recommended to typeset algorithms but not required. See the subsubsection on algorithms. Remove them if you don't have algorithms in your paper.
\usepackage{algorithm}
\usepackage{algorithmic}

% Custom packages
\usepackage{tikz}
\usepackage[inline]{enumitem}
\usepackage{pifont}  % for the checkmark/crossmark
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=.6pt] (char) {#1};}}
%
% These are are recommended to typeset listings but not required. See the subsubsection on listing. Remove this block if you don't have listings in your paper.
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%
% Keep the \pdfinfo as shown here. There's no need
% for you to add the /Title and /Author tags.
\pdfinfo{
/TemplateVersion (2024.1)
}

% DISALLOWED PACKAGES
% \usepackage{authblk} -- This package is specifically forbidden
% \usepackage{balance} -- This package is specifically forbidden
% \usepackage{color (if used in text)
% \usepackage{CJK} -- This package is specifically forbidden
% \usepackage{float} -- This package is specifically forbidden
% \usepackage{flushend} -- This package is specifically forbidden
% \usepackage{fontenc} -- This package is specifically forbidden
% \usepackage{fullpage} -- This package is specifically forbidden
% \usepackage{geometry} -- This package is specifically forbidden
% \usepackage{grffile} -- This package is specifically forbidden
% \usepackage{hyperref} -- This package is specifically forbidden
% \usepackage{navigator} -- This package is specifically forbidden
% (or any other package that embeds links such as navigator or hyperref)
% \indentfirst} -- This package is specifically forbidden
% \layout} -- This package is specifically forbidden
% \multicol} -- This package is specifically forbidden
% \nameref} -- This package is specifically forbidden
% \usepackage{savetrees} -- This package is specifically forbidden
% \usepackage{setspace} -- This package is specifically forbidden
% \usepackage{stfloats} -- This package is specifically forbidden
% \usepackage{tabu} -- This package is specifically forbidden
% \usepackage{titlesec} -- This package is specifically forbidden
% \usepackage{tocbibind} -- This package is specifically forbidden
% \usepackage{ulem} -- This package is specifically forbidden
% \usepackage{wrapfig} -- This package is specifically forbidden
% DISALLOWED COMMANDS
% \nocopyright -- Your paper will not be published if you use this command
% \addtolength -- This command may not be used
% \balance -- This command may not be used
% \baselinestretch -- Your paper will not be published if you use this command
% \clearpage -- No page breaks of any kind may be used for the final version of your paper
% \columnsep -- This command may not be used
% \newpage -- No page breaks of any kind may be used for the final version of your paper
% \pagebreak -- No page breaks of any kind may be used for the final version of your paperr
% \pagestyle -- This command may not be used
% \tiny -- This is not an acceptable font size.
% \vspace{- -- No negative value may be used in proximity of a caption, figure, table, section, subsection, subsubsection, or reference
% \vskip{- -- No negative value may be used to alter spacing above or below a caption, figure, table, section, subsection, subsubsection, or reference

\setcounter{secnumdepth}{0} %May be changed to 1 or 2 if section numbers are desired.

% The file aaai24.sty is the style file for AAAI Press
% proceedings, working notes, and technical reports.
%

% Title

% Your title must be in mixed case, not sentence case.
% That means all verbs (including short verbs like be, is, using,and go),
% nouns, adverbs, adjectives should be capitalized, including both words in hyphenated terms, while
% articles, conjunctions, and prepositions are lower case unless they
% directly follow a colon or long dash
\title{FedKit: Enabling Cross-Platform Federated Learning for Android and iOS}
\author{
    Sichang He, Beilong Tang, Boyang Zhang,
    Jiaqi Shao,
    Xiaomin Ouyang,
    Daniel Nata Nugraha,
    Bing Luo
}
\affiliations{}

\begin{document}

\maketitle

\begin{abstract}
    % "Federated learning" is an ordinary word combination.
    We present FedKit, a federated learning (FL) system tailored for
    cross-platform FL research on \textit{Android and iOS} devices.
    FedKit pipelines FL development in Python by
    % This is the first time model appears, so we should say "ML."
    enabling machine learning (ML) model conversion,
    native performance training,
    and cross-platform model aggregation.
    Our FL workflow supports flexible ML operations (MLOps) in production,
    facilitating continuous model delivery and training.
    We have deployed FedKit for conducting FL research on campus,
    showing its real-world effectiveness.
    FedKit is open-source at \url{https://github.com/FedCampus/FedKit}.
\end{abstract}

\section{Introduction}

Federated learning (FL) enables edge devices to
collaboratively train a shared machine learning (ML) model while
retaining private data on device \cite{mcmahan2017communication}.
Smartphones, rich in sensitive data,
are promising candidates for FL.
Nevertheless, most existing FL systems
\cite[e.g.,][]{bonawitz2019towards,liu2021fate,ma2019paddlepaddle,openfl_citation}
primarily cater to simulation,
limiting their practical use on smartphones.

Several FL systems have emerged to fulfill on-smartphone FL,
but still exhibit limitations,
as summarized in Table~\ref{tbl:fn-systems}.
Specifically, FedML \cite{he2020fedml},
Project Florida \cite{madrigal2023project},
and FedScale \cite{lai2022fedscale} primarily support Android.
On the other hand,
Flower \cite{beutel2020flower,mathur2021ondevice} and
Syft \cite{ryffel2018generic,Ziller2021,hall2021syft}
provide SDKs for both Android and iOS.
However, Flower SDKs lack support for on-device training and
cross-platform aggregation,
while Syft lacks hardware acceleration for on-device training.

In addition to seamless cross-platform support,
continuous deployment in production is crucial.
While FedML and Florida support ML operations (MLOps),
their proprietary services limit full customization.
In contrast, open-source solutions like Flower and Syft enable
full customization
but are more suitable for single experiments rather than continuous deployment.

\subsubsection{Contributions}
We developed FedKit,
a versatile FL system designed to enable \textbf{cross-platform} FL research on
\textbf{Android and iOS}:
\begin{enumerate}[label=$\bullet$]
    \item FedKit provides \textbf{modularized libraries} to train
        Python-based models on Android and iOS and
        aggregate across platforms.
        These libraries can serve as a foundational resource for
        on-device ML systems.
    \item We introduce a novel FL workflow in FedKit,
        enabling flexible \textbf{MLOps} from
        the backend in production.
        This innovation encourages other open-source solutions to
        rival proprietary services in deployment support.
\end{enumerate}

\section{System Description}

FedKit facilitates FL among Android and iOS clients (mobile apps),
coordinated by a single Backend server.
Each client trains a local model with private data,
and the Backend performs cross-platform aggregation of these local models to update the global model.
Specifically, FedKit introduces two key innovations: 
\circled{1} A cross-platform (Android-iOS) FL pipeline centered around ML models.
\circled{2} Flexible MLOps to enable efficient FL research iteration in production.

\begin{table}
    \centering
    \small
    \setlength{\tabcolsep}{2pt}
    \begin{tabular}{lccccc}
        Functionality        & FedML      & Florida    & Flower     & Syft       & \textbf{FedKit} \\
        \hline
        Android-Only         & \ding{51}  & \ding{51}  & \ding{51}  & \ding{51}  & \ding{51}       \\
        iOS-Only             & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}  & \ding{51}       \\
        Cross-Platform Aggr. & \ding{55}  & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}       \\
        \hline
        Training Acceleration& \ding{51}  & \ding{51}  & \ding{51}  & \ding{55}  & \ding{51}       \\
        MLOps                & \ding{51}  & \ding{51}  & \ding{55}  & \ding{55}  & \ding{51}       \\
        Open-Source Backend  & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}  & \ding{51}       \\
    \end{tabular}
    \caption{Functionality Comparison among On-Smartphone FL Systems.
    }
    \label{tbl:fn-systems}
\end{table}

\subsection{Cross-Platform FL Model Pipeline}

To enable cross-platform FL,
especially \textit{cross-platform aggregation},
we propose a pipeline comprising
\textit{model conversion} and
\textit{unified training APIs},
as shown in Fig.~\ref{cross_fl}.

\begin{figure}
    \centering
    \includegraphics*[width=\linewidth]{model_pipeline.pdf}
    \caption{FedKit Model Pipeline for Cross-Platform FL.}
    \label{cross_fl}
\end{figure}

\subsubsection{Model Conversion}
We begin in Python by converting models into formats compatible with
Android (TensorFlow Lite or TFLite) and iOS (Core ML).
Core ML defines a fixed model structure and provides
official converter CoreMLTools.
For TFLite, we \textit{standardized} a model format and
developed a compliant TensorFlow converter.
This standardized format includes
four essential FL methods
(\lstinline{train}, \lstinline{infer}, \lstinline{parameters},
and \lstinline{restore}).


\subsubsection{Unified Training APIs}
FedKit provides \textit{TFLite Trainer} and \textit{Core ML Trainer} to
train the converted models on Android and iOS devices,
utilizing GPU and NPU acceleration.
Moreover, both trainers expose unified APIs for
\textit{retrieving and setting model parameters,
model fitting and evaluation}.
On Android, these APIs invoke the TFLite interpreter to call
our standardized methods defined in Model Conversion.
However, on iOS, our experimentation revealed that
Core ML \textit{forbids} directly setting parameters, which could potentially impede FL.
To overcome this constraint,
we modify the underlying ProtoBuf representations of
Core ML models.
Specifically, we employ Swift code, generated from the relevant ProtoBuf definition files, which allows us to navigate nested model definitions and access parameters on iPhones. Thus, FedKit enables smooth FL operations on iOS devices aside from Android devices.


\subsubsection{Cross-Platform Aggregation}
The primary challenge in cross-platform aggregation lies in
the need for \textit{uniform parameter representations}. 

To achieve this uniformity, FedKit's trainers retrieve and set parameters as byte arrays,
following the order of model layers.
Additionally, we have employed separate strategies:
1) For Android, 
since the TFLite interpreter only accepts inputs and outputs as maps from \textit{names} to
\textit{tensors},
we automatically assign numerical names to
each layer of parameters based on their indices \textit{Model Conversion}.
This naming conversion allows access during training.
2) For iOS,
Core ML permits \textit{only} certain \textit{updatable layers} and only allows access to the \textit{updatable layers'} parameters after training.
Thus, to obtain \textit{other layers'} parameters,
we design an approach with ProtoBuf access to extract those parameters.
Additionally, for layer information retrieval,
we record the layer names generated by CoreMLTools during Model Conversion and
utilize them during training.

\subsection{Flexible MLOps in Production}
\newcommand{\model}{$M$}
\newcommand{\fs}{$S_\mathrm F$}
FedKit empowers researchers to continuously develop models and algorithms
by leveraging the self-hosted Backend (MLOps).
FedKit follows the three-step FL workflow, illustrated in (Fig.~\ref{fig:fl-workflow}).
In the following sections, we will elaborate on how these steps facilitate the integration of MLOps in production.
\begin{figure}
    \centering
    \includegraphics*[width=0.9\linewidth]{fl_workflow.pdf}
    \caption{FedKit FL Workflow.}
    \label{fig:fl-workflow}
\end{figure}

\subsubsection{Continuous Cross-Platform Model Delivery}
Traditionally, models for on-device training are \textit{embedded} into client sides (mobile apps).
However, this approach couples model delivery with app updates, 
resulting in complexities when submitting apps to app stores and garnering user adoption.


To handle this complexity,
FedKit enables \textit{continuous model delivery without app updates} by decoupling models from clients through the Model Request, which enables model delivery through uploads to the Backend.
Specifically, clients request the Backend for a model aligned with
their platform (Android/iOS) and training data type.
The Backend responds the appropriate model \model{} with detailed model information from the database.
Consequently, this seamless cross-platform model delivery provides clients with the TFLite or Core ML model for FL training.

\subsubsection{Customizable Continuous FL Training}
FedKit manages continuous FL training by allowing \textit{multiple FL training sessions parallelly}
through FL Server Setup.
When clients request for an FL Server to
train their chosen model \model{},
the Backend either reuses a suitable FL Server \fs{} (training \model{}) if it exists,
or spawns a new \fs{} with \model{}.
Each FL Server \fs{} 
operates as an independent Python subprocess of the Django Backend,
occupying its own port where the
clients connect for FL Training.
This dynamic approach ensures that
newly delivered models can be immediately trained with new FL Servers
without interfering with ongoing ones.
Furthermore, to enhance adaptability and customization, we have integrated FL Servers with the Flower FL Framework. This choice empowers our platform with robust scheduling capabilities for training and evaluation tasks, providing flexibility and enabling the customization of FL algorithms using Python.


\section{Use Case: FedCampus}

\begin{figure}
    \centering
    \includegraphics*[width=\linewidth]{fedcampus.pdf}
    \caption{FedCampus Experiment Setup.}
    \label{fig:fedcampus}
\end{figure}

We present a practical use case of FedKit, FedCampus,
a campus-based FL experiment.
Our research app, powered by FedKit,
conducts cross-platform FL with a sleep-efficiency prediction model
akin to \cite{khoa2022fedmcrnn}.

In the FedCampus experiment setup (Fig.~\ref{fig:fedcampus}),
we deployed a self-hosted Backend in the background,
with real-time logs and loss displayed on a connected laptop.
Our Flutter app collected exercise data from smartwatches
though Huawei HealthKit on the Android phone and Apple Health on the iPhone.
Notably, hardware acceleration kept both smartphones cool during training.
The outcome was a significant reduction in the model's training loss,
confirming FedKit's effectiveness in real-world scenarios.

\appendix

\section*{Acknowledgments}
We would like to thank Flower Labs for the discussion on on-device training.

\bigskip

\bibliography{main}

\end{document}
