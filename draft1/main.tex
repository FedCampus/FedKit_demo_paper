%File: anonymous-submission-latex-2024.tex
\documentclass[letterpaper]{article} % DO NOT CHANGE THIS
\usepackage[submission]{aaai24}  % DO NOT CHANGE THIS
\usepackage{times}  % DO NOT CHANGE THIS
\usepackage{helvet}  % DO NOT CHANGE THIS
\usepackage{courier}  % DO NOT CHANGE THIS
\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\graphicspath{ {./images/} }
\urlstyle{rm} % DO NOT CHANGE THIS
\def\UrlFont{\rm}  % DO NOT CHANGE THIS
\usepackage{natbib}  % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\usepackage{caption} % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\frenchspacing  % DO NOT CHANGE THIS
\setlength{\pdfpagewidth}{8.5in} % DO NOT CHANGE THIS
\setlength{\pdfpageheight}{11in} % DO NOT CHANGE THIS
%
% These are recommended to typeset algorithms but not required. See the subsubsection on algorithms. Remove them if you don't have algorithms in your paper.
\usepackage{algorithm}
\usepackage{algorithmic}

% Custom packages
\usepackage{tikz}
\usepackage[inline]{enumitem}
\usepackage{pifont}  % for the checkmark/crossmark
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=.6pt] (char) {#1};}}
%
% These are are recommended to typeset listings but not required. See the subsubsection on listing. Remove this block if you don't have listings in your paper.
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%
% Keep the \pdfinfo as shown here. There's no need
% for you to add the /Title and /Author tags.
\pdfinfo{
/TemplateVersion (2024.1)
}

% DISALLOWED PACKAGES
% \usepackage{authblk} -- This package is specifically forbidden
% \usepackage{balance} -- This package is specifically forbidden
% \usepackage{color (if used in text)
% \usepackage{CJK} -- This package is specifically forbidden
% \usepackage{float} -- This package is specifically forbidden
% \usepackage{flushend} -- This package is specifically forbidden
% \usepackage{fontenc} -- This package is specifically forbidden
% \usepackage{fullpage} -- This package is specifically forbidden
% \usepackage{geometry} -- This package is specifically forbidden
% \usepackage{grffile} -- This package is specifically forbidden
% \usepackage{hyperref} -- This package is specifically forbidden
% \usepackage{navigator} -- This package is specifically forbidden
% (or any other package that embeds links such as navigator or hyperref)
% \indentfirst} -- This package is specifically forbidden
% \layout} -- This package is specifically forbidden
% \multicol} -- This package is specifically forbidden
% \nameref} -- This package is specifically forbidden
% \usepackage{savetrees} -- This package is specifically forbidden
% \usepackage{setspace} -- This package is specifically forbidden
% \usepackage{stfloats} -- This package is specifically forbidden
% \usepackage{tabu} -- This package is specifically forbidden
% \usepackage{titlesec} -- This package is specifically forbidden
% \usepackage{tocbibind} -- This package is specifically forbidden
% \usepackage{ulem} -- This package is specifically forbidden
% \usepackage{wrapfig} -- This package is specifically forbidden
% DISALLOWED COMMANDS
% \nocopyright -- Your paper will not be published if you use this command
% \addtolength -- This command may not be used
% \balance -- This command may not be used
% \baselinestretch -- Your paper will not be published if you use this command
% \clearpage -- No page breaks of any kind may be used for the final version of your paper
% \columnsep -- This command may not be used
% \newpage -- No page breaks of any kind may be used for the final version of your paper
% \pagebreak -- No page breaks of any kind may be used for the final version of your paperr
% \pagestyle -- This command may not be used
% \tiny -- This is not an acceptable font size.
% \vspace{- -- No negative value may be used in proximity of a caption, figure, table, section, subsection, subsubsection, or reference
% \vskip{- -- No negative value may be used to alter spacing above or below a caption, figure, table, section, subsection, subsubsection, or reference

\setcounter{secnumdepth}{0} %May be changed to 1 or 2 if section numbers are desired.

% The file aaai24.sty is the style file for AAAI Press
% proceedings, working notes, and technical reports.
%

% Title

% Your title must be in mixed case, not sentence case.
% That means all verbs (including short verbs like be, is, using,and go),
% nouns, adverbs, adjectives should be capitalized, including both words in hyphenated terms, while
% articles, conjunctions, and prepositions are lower case unless they
% directly follow a colon or long dash
\title{FedKit: Enabling Cross-Platform Federated Learning for Android and iOS}
\author{}
\affiliations{}

\begin{document}

\maketitle

\begin{abstract}
    We present FedKit, a federated learning (FL) system tailored for
    cross-platform experiments on Android and iOS devices.
    FedKit pipelines FL development by
    enabling Python-based machine learning (ML) model conversion,
    native performance training with unified APIs,
    and platform-agnostic model aggregation.
    Our FL workflow supports flexible in-production customizations,
    facilitating rapid iterations of ML models and FL algorithms.
    We have deployed FedKit in a research app,
    achieving significant milestones.
    The code is open-source at \url{https://github.com/FedCampus/FedKit}.
\end{abstract}

\section{Introduction}

Federated Learning (FL) enables edge devices to
collaboratively train a shared Machine Learning (ML) model while
retaining private data on device \cite{mcmahan2017communication}.
Smartphones, rich in sensitive data,
emerge as promising candidates for participation in FL.
Nevertheless, most existing FL frameworks
\cite[e.g.,][]{bonawitz2019towards,liu2021fate,ma2019paddlepaddle,openfl_citation}
primarily cater to simulation,
limiting their practical use on smartphones.

Several FL frameworks have emerged to fulfill on-smartphone FL,
but still exhibit limitations,
as summarized in Table~\ref{tbl:fn-frameworks}.
Specifically, FedML \cite{he2020fedml},
Project Florida \cite{madrigal2023project},
and FedScale \cite{lai2022fedscale} primarily support Android.
Flower's \cite{beutel2020flower,mathur2021ondevice} Android and iOS SDKs have
not yet supported aggregating models across platforms.
PySyft \cite{ryffel2018generic,Ziller2021,hall2021syft}
accommodates FL across Android and iOS;
however, its custom on-device training approach lacks hardware acceleration,
significantly compromising performance.

In addition to seamless cross-platform support,
the ability to customize in real-world production settings is imperative.
FedML and Florida allows for running multiple ML models and
iterations in production settings,
but their proprietary services limits full customization.
In contrast, open-source solutions like Flower and PySyft enable
full customization,
but are more suitable for one-shot experiments,
limiting their adaptability for real-world FL experiments.

\subsubsection{Contributions}
We developed FedKit,
a versatile FL system designed to enable \textbf{cross-platform} FL research on
\textbf{Android and iOS}:
\begin{enumerate}[label=$\bullet$]
    \item FedKit provides \textbf{modularized libraries} to train
        Python-based ML models on Android and iOS and
        aggregate across platforms.
        These libraries can serve as a foundational resource for
        on-device FL systems.
    \item We introduce a novel FL workflow within FedKit,
        enabling flexible \textbf{customization} of ML models and FL algorithms from
        the backend, even in production settings.
        This innovation encourages other open-source solutions to
        rival proprietary services in deployment support.
\end{enumerate}

\section{System Description}

FedKit facilitates FL among clients (mobile apps) on Android and iOS platforms,
coordinated by a single Backend server.
Each client trains a local model with private data,
and the Backend aggregates these local models to update the global model.
Specifically, FedKit introduces two key innovations: 
\circled{1} A cross-platform (Android-iOS) FL pipeline centered around ML models.
\circled{2} In-production FL customization to enable efficient FL research iteration.

\begin{table}
    \centering
    \small
    \setlength{\tabcolsep}{2pt}
    \begin{tabular}{lccccc}
        Functionality        & FedML      & Florida    & Flower     & PySyft     & \textbf{FedKit} \\
        \hline
        Android-Only FL      & \ding{51}  & \ding{51}  & \ding{51}  & \ding{51}  & \ding{51}       \\
        iOS-Only FL          & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}  & \ding{51}       \\
        Cross Aggregation    & \ding{55}  & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}       \\
        Training Acceleration& \ding{51}  & \ding{51}  & \ding{51}  & \ding{55}  & \ding{51}       \\
        \hline
        Open-Source Backend  & \ding{55}  & \ding{55}  & \ding{51}  & \ding{51}  & \ding{51}       \\
        Multi Model/Iteration& \ding{51}  & \ding{51}  & \ding{55}  & \ding{55}  & \ding{51}       \\
    \end{tabular}
    \caption{Functionality Comparison among On-Smartphone FL frameworks
        as of Sep. 2023.
    }
    \label{tbl:fn-frameworks}
\end{table}

\subsection{Cross-Platform FL Model Pipeline}

To enable cross-platform FL,
especially \textit{cross-platform aggregation} across Android and iOS,
we propose a pipeline with
\textit{model conversion} and
\textit{unified training APIs},
as shown in Fig.~\ref{cross_fl}.

\begin{figure}
    \centering
    \includegraphics*[width=\linewidth]{cross_smart_fl_workflow.pdf}
    \caption{FedKit Model Pipeline for Cross-Platform FL.}
    \label{cross_fl}
\end{figure}

\subsubsection{Model Conversion}
We begin by converting Python-based ML models into formats compatible with
Android and iOS.
Specifically, we target Google's TensorFlow Lite (TFLite) for Android and
Apple's Core ML for iOS.
Core ML provides a well-defined model structure with
an official converter called CoreMLTools.
For TFLite, we have standardized the model format and
developed a Python converter for TensorFlow.
Our TFLite models encompass the four essential FL methods:
\lstinline{train}, \lstinline{infer}, \lstinline{parameters},
and \lstinline{restore}.

\subsubsection{Unified Training APIs}
We leverage TFLite and Core ML to train the converted models on device,
utilizing GPU and NPU acceleration.
Our trainers expose unified APIs including
functions for retrieving and setting parameters,
fitting, and evaluation.
On Android, these APIs invoke the TFLite interpreter to call
our standardized methods above.
However, on iOS, our experimentation revealed a crucial obstacle:
Core ML forbids directly setting parameters.

To overcome this constraint that could impede FL,
we modify the underlying ProtoBuf representations of
Core ML models.
Employing Swift code generated from the relevant ProtoBuf definition files,
we navigate nested model definitions and access parameters on iPhones.

\subsubsection{Cross-Platform Aggregation}
The primary challenge in cross-platform aggregation lies in
achieving uniform parameter representations.
Both trainers retrieve and set parameters as byte arrays,
following the order of model layers.
However, achieving this uniformity involved a complex process.
1)
The TFLite interpreter only accepts inputs and outputs as maps from names to
tensors.
During Model Conversion,
we automatically assign numerical names to
each layer of parameters based on their indices.
This allowed access during training by conversion between names and indices.
2)
Conversely, Core ML permits only certain layers to be updatable and
provide the parameters of these layers after training.
To obtain parameters for other layers,
we extract them using ProtoBuf access.
Additionally, for layer information retrieval,
we record the layer names generated by CoreMLTools during Model Conversion and
utilize them during training.

\subsection{Flexible In-Production FL Customization}
\newcommand{\model}{$M$}
\newcommand{\fs}{$S_\mathrm F$}
FedKit empowers researchers to iteratively develop models and algorithms
in production without app updates,
circumventing the complexity from app store submissions and user adoption.
Leveraging our self-hosted and directly controlled Backend,
we propose a three-step FL workflow
(Fig.~\ref{fig:fl-workflow}).
\begin{figure}
    \centering
    \includegraphics*[width=0.8\linewidth]{fl_workflow.pdf}
    \caption{FedKit FL Workflow.}
    \label{fig:fl-workflow}
\end{figure}

\subsubsection{Model Request}
Clients request for an ML model from the Backend that
aligns with their platform and training data type.
The Backend selects the appropriate model \model{} from its database.
This step allows deploying new models seamlessly
in production by uploading them to the Backend.

\subsubsection{FL Server Setup}
Clients request an FL Server from the Backend to
train their chosen model \model{}
(Fig.~\ref{fig:fl-workflow}.2).
The Backend assigns clients to an existing Fl Server \fs{} that
is already training \model{},
or spawns a new one on demand.
FL Servers, operating as the Backend's independent Python subprocesses,
occupy their own ports.
Researchers can customize how FL Servers are set up for each specific models by
adapting the Backend's Django implementation.

\subsubsection{FL Training}
Clients participate in FL training by directly connecting to
their assigned \fs{} on its port.
These FL Servers employ the Flower FL Framework for
scheduling training and evaluation.
They function as standard Flower gRPC servers,
inheriting Flower's flexibility,
allowing FL algorithm customizations in Python.

\section{Use Case: FedCampus}

\begin{figure}
    \centering
    % TODO: Closer laptop screen. More windows.
    \includegraphics*[width=0.7\linewidth]{fedcampus_demo.pdf}
    \caption{FedCampus Experiment Setup.
        The Backend runs on the server machine in the background,
        and its logs are shown on the laptop screen in real time.}
    \label{fig:fedcampus}
\end{figure}

We present a practical use case of FedKit, FedCampus,
a campus-based FL experiment.
We integrated FedKit into the FedCampus research app to
train a sleep-efficiency prediction model with exercise data,
similar to \cite{khoa2022fedmcrnn}.

Our experiment setup (Fig.~\ref{fig:fedcampus}) featured a self-hosted Backend
and collected data from participants' smartwatches
though Huawei HealthKit (Android) or Apple Health (iOS).
With participation from three test users,
our model's training loss reduction highlights
FedKit's real-world effectiveness.

\appendix

\section*{Acknowledgments}
We would like to thank Flower Labs for the discussion on on-device training.

\bigskip

\bibliography{main}

\end{document}
