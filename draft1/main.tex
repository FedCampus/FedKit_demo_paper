%File: anonymous-submission-latex-2024.tex
\documentclass[letterpaper]{article} % DO NOT CHANGE THIS
\usepackage[submission]{aaai24}  % DO NOT CHANGE THIS
\usepackage{times}  % DO NOT CHANGE THIS
\usepackage{helvet}  % DO NOT CHANGE THIS
\usepackage{courier}  % DO NOT CHANGE THIS
\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\graphicspath{ {./images/} }
\urlstyle{rm} % DO NOT CHANGE THIS
\def\UrlFont{\rm}  % DO NOT CHANGE THIS
\usepackage{natbib}  % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\usepackage{caption} % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\frenchspacing  % DO NOT CHANGE THIS
\setlength{\pdfpagewidth}{8.5in} % DO NOT CHANGE THIS
\setlength{\pdfpageheight}{11in} % DO NOT CHANGE THIS
%
% These are recommended to typeset algorithms but not required. See the subsubsection on algorithms. Remove them if you don't have algorithms in your paper.
\usepackage{algorithm}
\usepackage{algorithmic}

% Custom packages
\usepackage{tikz}
\usepackage[inline]{enumitem}
\usepackage{amssymb}  % for the checkmark
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=.6pt] (char) {#1};}}
%
% These are are recommended to typeset listings but not required. See the subsubsection on listing. Remove this block if you don't have listings in your paper.
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%
% Keep the \pdfinfo as shown here. There's no need
% for you to add the /Title and /Author tags.
\pdfinfo{
/TemplateVersion (2024.1)
}

% DISALLOWED PACKAGES
% \usepackage{authblk} -- This package is specifically forbidden
% \usepackage{balance} -- This package is specifically forbidden
% \usepackage{color (if used in text)
% \usepackage{CJK} -- This package is specifically forbidden
% \usepackage{float} -- This package is specifically forbidden
% \usepackage{flushend} -- This package is specifically forbidden
% \usepackage{fontenc} -- This package is specifically forbidden
% \usepackage{fullpage} -- This package is specifically forbidden
% \usepackage{geometry} -- This package is specifically forbidden
% \usepackage{grffile} -- This package is specifically forbidden
% \usepackage{hyperref} -- This package is specifically forbidden
% \usepackage{navigator} -- This package is specifically forbidden
% (or any other package that embeds links such as navigator or hyperref)
% \indentfirst} -- This package is specifically forbidden
% \layout} -- This package is specifically forbidden
% \multicol} -- This package is specifically forbidden
% \nameref} -- This package is specifically forbidden
% \usepackage{savetrees} -- This package is specifically forbidden
% \usepackage{setspace} -- This package is specifically forbidden
% \usepackage{stfloats} -- This package is specifically forbidden
% \usepackage{tabu} -- This package is specifically forbidden
% \usepackage{titlesec} -- This package is specifically forbidden
% \usepackage{tocbibind} -- This package is specifically forbidden
% \usepackage{ulem} -- This package is specifically forbidden
% \usepackage{wrapfig} -- This package is specifically forbidden
% DISALLOWED COMMANDS
% \nocopyright -- Your paper will not be published if you use this command
% \addtolength -- This command may not be used
% \balance -- This command may not be used
% \baselinestretch -- Your paper will not be published if you use this command
% \clearpage -- No page breaks of any kind may be used for the final version of your paper
% \columnsep -- This command may not be used
% \newpage -- No page breaks of any kind may be used for the final version of your paper
% \pagebreak -- No page breaks of any kind may be used for the final version of your paperr
% \pagestyle -- This command may not be used
% \tiny -- This is not an acceptable font size.
% \vspace{- -- No negative value may be used in proximity of a caption, figure, table, section, subsection, subsubsection, or reference
% \vskip{- -- No negative value may be used to alter spacing above or below a caption, figure, table, section, subsection, subsubsection, or reference

\setcounter{secnumdepth}{0} %May be changed to 1 or 2 if section numbers are desired.

% The file aaai24.sty is the style file for AAAI Press
% proceedings, working notes, and technical reports.
%

% Title

% Your title must be in mixed case, not sentence case.
% That means all verbs (including short verbs like be, is, using,and go),
% nouns, adverbs, adjectives should be capitalized, including both words in hyphenated terms, while
% articles, conjunctions, and prepositions are lower case unless they
% directly follow a colon or long dash
\title{FedKit: Enabling Cross-Platform Federated Learning for Android and iOS}
\author{}
\affiliations{}

\begin{document}

\maketitle

\begin{abstract}
    We present FedKit, a federated learning (FL) system tailored for
    cross-platform experiments on Android and iOS devices.
    FedKit pipelines FL development by
    enabling Python-based machine learning (ML) model conversion,
    native performance training with unified APIs,
    and platform-agnostic model aggregation.
    Our FL workflow supports flexible in-production customizations,
    facilitating rapid iterations of ML models and FL algorithms.
    We have deployed FedKit in a research app,
    achieving significant milestones.
    The code is open-source at \url{https://github.com/FedCampus/FedKit}.
\end{abstract}

\section{Introduction}

Federated Learning (FL) 
is a privacy-preserving machine learning (ML) technique
that enables edge devices to collaboratively train a shared model while
retaining private data on-device \cite{mcmahan2017communication}.
Smartphones, with their extensive access to sensitive data,
emerge as promising candidates for participation in FL.
To conduct practical FL experiments on smartphones,
it is imperative to establish a comprehensive system that
not only supports cross-platform on-device training,
but also provides the flexibility to make adjustments in production settings.

However, existing FL systems often fall short of meeting multiple prerequisites
(Table~\ref{tbl:fn-frameworks}).
First, most systems struggle to provide seamless support for both Android and iOS.
They do not operate directly on smartphones
\cite[e.g.,][]{bonawitz2019towards,liu2021fate,ma2019paddlepaddle,openfl_citation},
merely support Android (e.g.,
FedML \cite{he2020fedml}, Project Florida \cite{madrigal2023project}
and FedScale \cite{lai2022fedscale}),
or provide only iOS SDKs (Flower \cite{beutel2020flower,mathur2021ondevice}).
Although PySyft \cite{ryffel2018generic,Ziller2021,hall2021syft} supports
both Android and iOS, it employs
a custom on-device training approach that significantly compromises performance.
Second, while proprietary services like FedML and Florida cannot
be self-hosted and fully customized,
they offer the advantage of customizations in production settings.
In contrast, open-source solutions such as Flower and PySyft primarily
support one-shot experiments.

\subsubsection{Contributions}
We developed FedKit,
a versatile FL system designed to enable \textbf{cross-platform} FL research on
\textbf{Android and iOS}:
\begin{enumerate}[label=$\bullet$]
    \item FedKit provides a set of \textbf{modularized libraries} to train
        Python-based ML models on Android and iOS and
        aggregate across platforms.
        These libraries can serve as a foundational resource for
        on-device FL systems.
    \item We introduce a novel FL workflow within FedKit,
        enabling flexibly \textbf{customize} ML models and implement FL algorithms from
        the backend, even in production settings.
        This innovative approach inspires other open-source solutions to
        compete with proprietary services in deployment support.
\end{enumerate}

\section{System Description}

FedKit facilitates FL among clients (mobile apps) on Android and iOS platforms,
coordinated by a single Backend server.
Each client trains a local model with private data,
and the Backend aggregates these local models to update the global model.
Specifically, FedKit introduces two key innovations: 
\circled{1} A cross-platform (Android-iOS) FL pipeline centered around ML models.
\circled{2} In-production FL customization to enable efficient FL research iteration.

\begin{table}
    \centering
    \small
    \setlength{\tabcolsep}{2.4pt}
    \begin{tabular}{lccccc}
        Support              & FedML      & Florida    & Flower     & PySyft     & \textbf{FedKit} \\
        \hline
        Android              & \checkmark & \checkmark & $\checkmark^\ast$ & \checkmark & \checkmark      \\
        iOS                  &            &            & \checkmark & \checkmark & \checkmark      \\
        Native Performance   & $\bigcirc$ & $\bigcirc$ & \checkmark &            & \checkmark      \\
        Self-Host            &            &            & \checkmark & \checkmark & \checkmark      \\
        Customize in Prod    & \checkmark & \checkmark &            &            & \checkmark      \\
    \end{tabular}
    \caption{Functionality Comparison among On-Smartphone FL frameworks
        as of Sep. 2023.
        $\checkmark^\ast$: full support after our contribution.
        $\bigcirc$: partial support.
    }
    \label{tbl:fn-frameworks}
\end{table}

\subsection{Cross-Platform FL Model Pipeline}

To enable cross-platform FL across Android and iOS,
we aim to create, train and aggregate ML models conveniently while
utilizing GPU and NPU acceleration.
Our approach involves \textit{model conversion},
\textit{unified training APIs},
and \textit{cross-platform aggregation}, as illustrated Fig.~\ref{cross_fl}.

\begin{figure}
    \centering
    \includegraphics*[width=\linewidth]{cross_smart_fl_workflow.pdf}
    \caption{FedKit Model Pipeline for Cross-Platform FL.}
    \label{cross_fl}
\end{figure}

\subsubsection{Model Conversion}
We begin by converting Python-based ML models into formats compatible with
Android and iOS.
Specifically, we target Google's TensorFlow Lite (TFLite) for Android and
Apple's Core ML for iOS.
Core ML provides a well-defined model structure with
an official converter called CoreMLTools.
For TFLite, we have standardized the model format and
developed a Python converter for TensorFlow.
Our TFLite models encompass the four essential FL methods:
parameter \texttt{read}/\texttt{update}, \texttt{train}, and \texttt{infer}.

\subsubsection{Unified Training APIs}
With the converted models in hand,
we leverage platform-specific ML frameworks to
perform training on Android and iOS.
To ensure cross-platform support,
we have developed a set of unified APIs exposed by both trainers.
These APIs include functions for retrieving and setting parameters,
model fitting, and evaluation.
On Android, we implement these APIs by indirectly invoking
our standardized methods within the TFLite interpreter.
However, on iOS, our experimentation revealed a significant constraint:
Core ML disallows directly setting model parameters.
To circumvent this restriction,
we manually modify the parameters in the underlying ProtoBuf representations of
Core ML models.

\subsubsection{Cross-Platform Aggregation}
In the previous steps,
we convert and train a single model into two distinct formats for
Android and iOS.
Traditionally, this would require separate aggregation processes.
However, we have designed FedKit to ensure unified parameter representation
on both platforms.
During model conversion,
we record the updatable model layers in the same order.
During training,
our API implementations access these layers sequentially to
retrieve or insert parameters as byte arrays.

\subsection{Flexible In-Production FL Customization}
\newcommand{\model}{$M$}
\newcommand{\fs}{$S_\mathrm F$}
Traditionally, conducting FL research on smartphones involved
embedding models and training procedures into client apps.
However, this approach led to the necessity for frequent app updates,
introducing complexity from app store submissions and user adoption
in production.

In contrast,
FedKit empowers researchers to iteratively develop models and algorithms
in production.
Leveraging our self-hosted and directly controlled Backend,
we propose a three-step FL workflow
(Fig.~\ref{fig:fl-workflow}).
\begin{figure}
    \centering
    \includegraphics*[width=0.8\linewidth]{fl_workflow.pdf}
    \caption{FedKit FL Workflow.}
    \label{fig:fl-workflow}
\end{figure}

\subsubsection{Model Request}
Clients request for an ML model from the Backend that
aligns with their platform and training data type
(Fig.~\ref{fig:fl-workflow}.1).
The Backend selects the appropriate model \model{} from its database.
This step allows FL researchers to deploy new models seamlessly
in production by uploading them to the Backend.

\subsubsection{FL Server Setup}
Clients request an FL Server from the Backend to
train their chosen model \model{}
(Fig.~\ref{fig:fl-workflow}.2).
The Backend assigns clients to an existing Fl Server \fs{} that
is already training \model{},
or spawns a new one on demand.
FL Servers, operating as the Backend's independent Python subprocesses,
occupy their own ports.
Researchers can customize how FL Servers are set up for each specific models by
adapting the Backend's Django implementation.

\subsubsection{Training}
Clients participate in FL training by directly connecting to
their assigned \fs{} on its port
(Fig.~\ref{fig:fl-workflow}.3).
These FL Servers employ the Flower FL Framework for
scheduling training and evaluation.
They function as standard Flower gRPC servers,
inheriting Flower's flexibility,
allowing FL algorithm customizations in Python.

\section{Use Case: FedCampus}

We present a practical use case of FedKit, FedCampus,
a campus-based FL experiment.
We integrated FedKit into the FedCampus research app to
train a sleep-efficiency prediction model with exercise data,
similar to \cite{khoa2022fedmcrnn}.

Our experiment setup (Fig.~\ref{fig:fedcampus}) featured a self-hosted Backend
and collected data from participants' smartwatches
though Huawei HealthKit (Android) or Apple Health (iOS).
With participation from three test users,
our model's training loss reduction highlights
FedKit's real-world effectiveness.

\begin{figure}
    \centering
    \includegraphics*[width=0.7\linewidth]{fedcampus_demo.pdf}
    \caption{FedCampus Experiment Setup.
        The Backend runs on the server machine in the background,
        and its logs are shown on the laptop screen in real time.}
    \label{fig:fedcampus}
\end{figure}

\appendix

\section*{Acknowledgments}
TODO

\bigskip

\bibliography{main}

\end{document}
