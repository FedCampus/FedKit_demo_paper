%File: anonymous-submission-latex-2024.tex
\documentclass[letterpaper]{article} % DO NOT CHANGE THIS
\usepackage[submission]{aaai24}  % DO NOT CHANGE THIS
\usepackage{times}  % DO NOT CHANGE THIS
\usepackage{helvet}  % DO NOT CHANGE THIS
\usepackage{courier}  % DO NOT CHANGE THIS
\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\urlstyle{rm} % DO NOT CHANGE THIS
\def\UrlFont{\rm}  % DO NOT CHANGE THIS
\usepackage{natbib}  % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\usepackage{caption} % DO NOT CHANGE THIS AND DO NOT ADD ANY OPTIONS TO IT
\frenchspacing  % DO NOT CHANGE THIS
\setlength{\pdfpagewidth}{8.5in} % DO NOT CHANGE THIS
\setlength{\pdfpageheight}{11in} % DO NOT CHANGE THIS
%
% These are recommended to typeset algorithms but not required. See the subsubsection on algorithms. Remove them if you don't have algorithms in your paper.
\usepackage{algorithm}
\usepackage{algorithmic}

% Custom packages
\usepackage{tikz}
\usepackage[inline]{enumitem}

%
% These are are recommended to typeset listings but not required. See the subsubsection on listing. Remove this block if you don't have listings in your paper.
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%
% Keep the \pdfinfo as shown here. There's no need
% for you to add the /Title and /Author tags.
\pdfinfo{
/TemplateVersion (2024.1)
}

% DISALLOWED PACKAGES
% \usepackage{authblk} -- This package is specifically forbidden
% \usepackage{balance} -- This package is specifically forbidden
% \usepackage{color (if used in text)
% \usepackage{CJK} -- This package is specifically forbidden
% \usepackage{float} -- This package is specifically forbidden
% \usepackage{flushend} -- This package is specifically forbidden
% \usepackage{fontenc} -- This package is specifically forbidden
% \usepackage{fullpage} -- This package is specifically forbidden
% \usepackage{geometry} -- This package is specifically forbidden
% \usepackage{grffile} -- This package is specifically forbidden
% \usepackage{hyperref} -- This package is specifically forbidden
% \usepackage{navigator} -- This package is specifically forbidden
% (or any other package that embeds links such as navigator or hyperref)
% \indentfirst} -- This package is specifically forbidden
% \layout} -- This package is specifically forbidden
% \multicol} -- This package is specifically forbidden
% \nameref} -- This package is specifically forbidden
% \usepackage{savetrees} -- This package is specifically forbidden
% \usepackage{setspace} -- This package is specifically forbidden
% \usepackage{stfloats} -- This package is specifically forbidden
% \usepackage{tabu} -- This package is specifically forbidden
% \usepackage{titlesec} -- This package is specifically forbidden
% \usepackage{tocbibind} -- This package is specifically forbidden
% \usepackage{ulem} -- This package is specifically forbidden
% \usepackage{wrapfig} -- This package is specifically forbidden
% DISALLOWED COMMANDS
% \nocopyright -- Your paper will not be published if you use this command
% \addtolength -- This command may not be used
% \balance -- This command may not be used
% \baselinestretch -- Your paper will not be published if you use this command
% \clearpage -- No page breaks of any kind may be used for the final version of your paper
% \columnsep -- This command may not be used
% \newpage -- No page breaks of any kind may be used for the final version of your paper
% \pagebreak -- No page breaks of any kind may be used for the final version of your paperr
% \pagestyle -- This command may not be used
% \tiny -- This is not an acceptable font size.
% \vspace{- -- No negative value may be used in proximity of a caption, figure, table, section, subsection, subsubsection, or reference
% \vskip{- -- No negative value may be used to alter spacing above or below a caption, figure, table, section, subsection, subsubsection, or reference

\setcounter{secnumdepth}{0} %May be changed to 1 or 2 if section numbers are desired.

% The file aaai24.sty is the style file for AAAI Press
% proceedings, working notes, and technical reports.
%

% Title

% Your title must be in mixed case, not sentence case.
% That means all verbs (including short verbs like be, is, using,and go),
% nouns, adverbs, adjectives should be capitalized, including both words in hyphenated terms, while
% articles, conjunctions, and prepositions are lower case unless they
% directly follow a colon or long dash
\title{FedKit---Facilitating Cross-Smartphone-Platform Federated Learning Research}
\author{}
\affiliations{}

\begin{document}

\maketitle

\begin{abstract}
    Federated Learning (FL) creates a new technological pathway for
    harnessing the data on billions of smartphones.
    However, before the industry adopts FL designs in production,
    researchers need to test and iterate on them under real-world circumstances.
    For this purpose,
    we developed FedKit to be a practical system that provides researchers
    a cross-smartphone-platform FL environment.
    It federates learning models across smartphones platforms,
    and offers in-production customizations.
    We have already successfully deployed FedKit for our research app
    in production and attained significant milestones.
\end{abstract}

\section{Introduction}

Federated learning (FL)
is machine learning (ML) technique that preserves user privacy by
allowing smartphones to collaboratively train a shared ML model while
keeping training data local.
If achieved, FL on smartphones would allow the general industry to
harness the vast amount of data available on smartphones.

But before that, researchers need practical FL systems to test and
iterate on their FL designs under real-world circumstances.
Most promising FL frameworks
\cite[e.g.,][]{bonawitz2019towards,liu2021fate,ma2019paddlepaddle,openfl_citation}
do not support smartphones.
% TODO: Chart of FL frameworks' platform support.
Some systems only support Android
\cite{he2020fedml,madrigal2023project},
but real-world FL scenarios must also include iOS.
Several FL services present proprietary backends,
but researchers need direct customization abilities.
Open-source solutions are in early exploration stages
\cite{beutel2020flower,mathur2021ondevice},
or suffer from performance penalties from custom training implementations
\cite{ryffel2018generic,Ziller2021,hall2021syft}.
% TODO: Cite more.
Moreover, these systems mostly assume a one-shot experiment and
provide little support for researchers to change their designs in production.
Previous work has yet to facilitate general cross-smartphone-platform
FL research.

So, we developed FedKit,
an open-source system to facilitate
cross-smartphone-platform FL research.
FedKit leverages platform-specific smartphone ML frameworks,
yet provides a unified FL interface.
To enable fast FL research iteration,
it also offers researchers FL customization in production.

\section{System Description}

FedKit federates learning among client apps across smartphone platforms and
a single Backend server.
% TODO: Figure of system structure.
Each client trains a local ML model with its private data on the smartphone.
Then, the Backend aggregates these local models to update the global model.

In practice, this system faces significant intricacies in
on-device ML training and mobile development-production cycle.
To facilitate cross-smartphone-platform FL research,
FedKit features two innovations:
\begin{enumerate*}[label=\arabic*)]
    \item cross-smartphone-platform FL support using
          native smartphone ML frameworks, and
    \item flexible FL customization in production enabled by
          our custom FL workflow
\end{enumerate*}.

\subsection{Cross-Smartphone-Platform FL}

For an ML model created in Python,
we want to train and aggregate it conveniently across Android and iOS.
We also want to utilize GPUs and NPUs to accelerate training.
For these, we convert the models to supported formats,
train them under unified APIs using smartphone ML frameworks,
and aggregate the parameters in unified representations.

\subsubsection{Model Conversion}
% TODO: Figure of ML model conversion.
We convert TensorFlow models into supported formats,
targeting Google's TensorFlow Lite (TFLite) for Android,
and Apple's Core ML for iOS.
Core ML already has a defined model form and an official converter called
CoreMLTools.
For TFLite, we standardized the model form ourselves and
provide a Python converter.
Our standard TFLite models include four necessary methods for FL:
read and update parameters, train, and infer.

\subsubsection{Unified Training APIs}
With the converted models, we use corresponding frameworks to train them
on smartphones.
For cross-platform support,
we designed a set of unified APIs that both trainers expose,
including functions to get and set parameters, fit and evaluate the model.
On Android, we implement these APIs by indirectly calling
our four standardized methods in the TFLite interpreter.
On iOS, however, we found out in our experiments that
Core ML disallows setting model parameters,
which would make FL impossible.
To jail-break from this restriction, we manually alter
Core ML models' underlying ProtoBuf representations.

\subsubsection{Cross-Platform Aggregation}
In the previous two steps,
a single model would get converted and trained into two models in
completely different formats.
Naively, we would need to aggregate them separately.
Instead, we carefully design FedKit so the APIs to get and set model parameters
yield the same representation on both platforms.
During model conversion,
the updatable model layers are recorded in the same order.
The training API implementations then sequentially access these layers to
retrieve or insert the parameters as byte arrays.

\subsection{Flexible In-Production FL Customization}
% TODO: Mention self-host.
\newcommand{\model}{$M$}
\newcommand{\fs}{$S_\mathrm F$}
After being able to federate learning on smartphones,
the traditional approach would hard-code the model and training procedure
into the client app.
But then, the app would need to be updated every time a change is made,
involving the complication of app stores and users in production.
Instead,
we want to empower FL researchers to conveniently iterate on ML models and
explore new FL algorithms
without updating the app.
Therefore, we propose a three-step FL workflow that
enables customizing ML models and FL algorithms in production.
% TODO: Figure of structure with workflow, numbered.

\subsubsection{Model Request}
Clients request the Backend for an ML model \model{} that fits
their platform and training data type (Fig. ). % TODO: fig.
The Backend decides which model to train based on
available models in its database.
So, FL researchers simply deploy new models in production by uploading them to
the Backend.

\subsubsection{Training Initiation}
Clients request the Backend for an FL Server \fs{} to train \model.
If there exists an FL Server already training \model,
The Backend assigns new clients to it;
otherwise, it spawns a new \fs.
Since FL Servers are the Backend's Python subprocesses,
they allow for multiple simultaneous yet independent FL sessions.
Furthermore, researchers can map each model to a tailored FL Server by
customizing the Backend's Django implementation.

\subsubsection{Training}
Clients participate in regular FL training by connecting to \fs.
These FL Servers leverage the user-friendly Flower FL Framework to
schedule training and evaluation.
They are regular Flower gRPC servers, meaning that
they inherit all of Flower's great flexibility to customize the FL algorithm in
Python.

\section{Experiment and Conclusion}
To demonstrate FedKit in action,
we deployed an app that federates learning using exercise data collected from
smart watches.
% TODO: figure of phones.
This Flutter app trains a sleep-efficiency prediction model similar to \cite{khoa2022fedmcrnn}
%TODO: Cite FedMCRNN
using data obtained from Huawei HealthKit
on Android and Apple Health on iOS.
We had 3 test users who opened the app to train the model at least once a day,
resulting in decreasing training loss.
% TODO: Training telemetry graph. Is loss going down?

In conclusion, our FL experiments with FedKit aim to
expand researchers' reach to billions of smartphones,
unlocking FL's immense potential to benefit the masses.

\appendix

\section*{Acknowledgments}
TODO

\bigskip

\bibliography{main}

\end{document}
